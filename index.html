<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white">
    <div id="quiz-container" class="max-w-md mx-auto p-4 border rounded-2xl shadow-sm">
        <div id="loading" class="text-center py-10 text-gray-500 italic">Initialisation...</div>
        
        <div id="quiz-content" class="hidden">
            <h1 id="question" class="text-xl font-bold text-gray-900 mb-5"></h1>
            <form id="quiz-form" class="space-y-3">
                <div id="options-container" class="space-y-2"></div>
                <button type="submit" id="submit-btn" class="w-full bg-black text-white py-3 rounded-xl mt-4">Valider</button>
            </form>
            <div id="result" class="hidden mt-5 p-4 rounded-xl border">
                <p id="result-text" class="font-bold"></p>
                <p id="explanation" class="text-sm mt-1"></p>
            </div>
        </div>
    </div>

    <script>
    // 1. CONFIGURATION: Your Published Web App URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxS1AiF9YIkNRtx6jNEHktZlTURrjbkxREgqj1v2CYc7mynfqHw0hgYXdoC-m1I1cAv2A/exec";

    async function loadQuestion() {
        console.log("--- DEBUG START ---");
        
        // 2. GET ID FROM URL (Directly, no parent/iframe logic needed)
        const urlParams = new URLSearchParams(window.location.search);
        const questionId = urlParams.get('id') || "2"; // Defaults to row 2 if no ID
        
        console.log("URL detected:", window.location.href);
        console.log("Targeting Question ID:", questionId);

        document.getElementById('loading').textContent = `Chargement de la question ${questionId}...`;

        try {
            const fetchUrl = `${SCRIPT_URL}?id=${questionId}`;
            console.log("Requesting data from Apps Script...");

            const response = await fetch(fetchUrl);
            
            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);

            const data = await response.json();
            console.log("JSON Received:", data);

            // Safety check: Make sure the JSON has the expected keys
            if (!data.question || !data.choix) {
                throw new Error("JSON structure is incorrect. Check Column E in your sheet.");
            }

            renderQuiz(data);
        } catch (err) {
            console.error("CRITICAL ERROR:", err.message);
            document.getElementById('loading').innerHTML = `
                <div class="text-red-600 font-bold">Erreur de chargement</div>
                <div class="text-xs text-gray-500 mt-2">Détails : ${err.message}</div>
                <div class="text-[10px] text-gray-400 mt-4">Vérifiez que le Web App est déployé en 'Anyone'</div>
            `;
        }
    }

    function renderQuiz(data) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('quiz-content').classList.remove('hidden');
        document.getElementById('question').textContent = data.question;

        const container = document.getElementById('options-container');
        container.innerHTML = ""; // Clear any previous content

        data.choix.forEach((text, index) => {
            const div = document.createElement('div');
            div.innerHTML = `
                <input type="radio" name="answer" id="opt${index}" value="${index}" class="hidden peer" required>
                <label for="opt${index}" class="flex items-center p-3 border rounded-lg cursor-pointer peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:bg-gray-50 transition-all text-sm">
                    <span class="mr-2 opacity-50 font-mono">${String.fromCharCode(65 + index)}.</span>
                    ${text}
                </label>
            `;
            container.appendChild(div);
        });

        document.getElementById('quiz-form').onsubmit = (e) => {
            e.preventDefault();
            const userAns = parseInt(new FormData(e.target).get('answer'));
            const isCorrect = userAns === data.reponse_correcte;
            
            console.log("Submission:", { userAns, correctAns: data.reponse_correcte, result: isCorrect });

            const resDiv = document.getElementById('result');
            resDiv.classList.remove('hidden');
            resDiv.className = isCorrect ? "mt-5 p-4 rounded-xl bg-green-50 border border-green-200" : "mt-5 p-4 rounded-xl bg-red-50 border border-red-200";
            
            document.getElementById('result-text').textContent = isCorrect ? "✅ Bravo !" : "❌ Incorrect";
            document.getElementById('result-text').className = isCorrect ? "font-bold text-green-800" : "font-bold text-red-800";
            
            // Explanation logic: handles both nested objects and simple strings
            const exp = data.explication;
            const explanationText = isCorrect ? 
                (exp.explication_succes || exp) : 
                (exp.explication_erreur || exp);
            
            document.getElementById('explanation').textContent = explanationText;
            document.getElementById('submit-btn').classList.add('hidden');
        };
    }

    loadQuestion();
</script>
</body>
</html>
